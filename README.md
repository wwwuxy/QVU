# QVU

QVU (Quantization Vector Unit) 是一个基于Chisel的高效量化处理器，用于将Posit数值格式量化为不同的目标格式，包括整数和浮点数。

## 支持的量化操作

QVU支持以下量化操作类型（通过op控制）：

| 操作码 | 操作名称 | 功能描述 |
|--------|---------|---------|
| 0 | QuantizeInt8 | 将Posit量化为Int8整数 |
| 1 | QuantizeInt4 | 将Posit量化为Int4整数 |
| 2 | QuantizeFP16 | 将Posit量化为FP16浮点数 |
| 3 | QuantizeFP8 | 将Posit量化为FP8浮点数 |
| 4 | QuantizeFP4 | 将Posit量化为FP4浮点数 |

## 浮点数格式

支持的浮点数格式由float_mode控制：

| 模式 | 格式 | 位宽分配 |
|-----|------|---------|
| 0 | FP4 | 1位符号, 1位指数, 2位尾数 |
| 1 | FP8 | 1位符号, 4位指数, 3位尾数 |
| 2 | FP16 | 1位符号, 5位指数, 10位尾数 |
| 3 | FP32 | 1位符号, 8位指数, 23位尾数 |
| 4 | FP64 | 1位符号, 11位指数, 52位尾数 |

## FP4量化功能

FP4量化模块将Posit数值格式量化为4位浮点数表示，采用滑动窗口自适应量化策略，使用定点算术进行高效计算。

### FP4编码值

FP4使用4位宽（1位符号，1位指数，2位尾数）表示以下16个离散值：

| 编码 | 值 | 描述 |
|------|-----|-----|
| 0000 | +0.0 | 正零 |
| 1000 | -0.0 | 负零 |
| 0001 | +0.25 | 正四分之一 |
| 1001 | -0.25 | 负四分之一 |
| 0010 | +0.5 | 正二分之一 |
| 1010 | -0.5 | 负二分之一 |
| 0011 | +0.75 | 正四分之三 |
| 1011 | -0.75 | 负四分之三 |
| 0100 | +1.0 | 正一 |
| 1100 | -1.0 | 负一 |
| 0101 | +1.5 | 正一点五 |
| 1101 | -1.5 | 负一点五 |
| 0110 | +2.0 | 正二 |
| 1110 | -2.0 | 负二 |
| 0111 | +3.0 | 正三 |
| 1111 | -3.0 | 负三 |

### 使用方法

通过将QVU的op参数设置为4，可以启用Posit至FP4的量化：

```scala
// 配置QVU以执行FP4量化
io.op := 4.U        // 选择FP4量化操作
io.Isposit := true.B  // 输入为Posit格式
io.posit_i1 := positValues  // 输入Posit向量

// 量化结果将输出到io.float_o接口
val fp4Results = io.float_o
```

## 编译和运行

使用SBT或Mill构建系统编译项目：

```bash
sbt compile   # 使用SBT编译
# 或
mill pvu.compile  # 使用Mill编译
```

## 参数配置

QVU模块支持以下参数配置：

- MAX_POSIT_WIDTH: 最大Posit位宽
- MAX_VECTOR_SIZE: 最大向量大小
- MAX_ALIGN_WIDTH: 最大对齐宽度
- ES: Posit的ES参数
- FLOAT_MODE: 默认浮点数格式 (默认为3，即FP32)
- INT_WIDTH: 整数位宽参数 (默认为32)